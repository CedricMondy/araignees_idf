---
title: "<%=family%>"
header-includes:
  - <link rel="stylesheet" href="modal.css">
  - <script src="modal.js"></script>
---

Site de Pierre Oger: <%=
{
  liens_genitalia <- pages_genitalia[stringr::str_detect(pages_genitalia, stringr::str_to_lower(family))]
  cat(
    paste0(
      "[espèces](",
      pages_familles[stringr::str_detect(pages_familles, stringr::str_to_lower(family))],
      ")"
      )
    )
  cat(
    sapply(
      liens_genitalia,
        function(x) {
          if (stringr::str_detect(x, "dae_f")) {
              paste0(", [genitalias femelle](", x, ")")
            } else {
              if (stringr::str_detect(x, "dae_m")) {
                paste0(", [genitalias mâle](", x, ")")
              } else {
                paste0(", [genitalias](", x, ")")
              }
            }
          }
        )
      )
}
  
%>

<%=
for (genus in genera) {
  especes <- liste_esp |> 
    dplyr::filter(stringr::str_starts(taxon, pattern = genus))

  nb_sp <- nrow(especes)
  
  nb_sp_id <- especes |> 
    dplyr::filter(id_vue == 'oui') |> 
    nrow()
    
  cat(paste0(
    "\n\n## ", genus, "\n\n",
    nb_sp, " espèce", ifelse(nb_sp > 1, "s", ""), " en Île-de-France", 
    dplyr::case_when(
      nb_sp == 1 & nb_sp_id == 1 ~ " identifiable à vue",
      nb_sp == 1 & nb_sp_id == 0 ~ " non identifiable à vue",
      nb_sp > 1 & nb_sp_id == 0 ~ ", aucune identifiable à vue",
      nb_sp > 1 & nb_sp_id == 1 ~ " dont 1 identifiable à vue",
      nb_sp > 1 & nb_sp_id == nb_sp ~ ", toutes identifiables à vue",
      TRUE ~ paste0(" dont ", nb_sp_id, " identifiables à vue")
    ),
    "\n\n"
  ))
  
  sapply(
      especes$taxon,
      function(species) {
      difficulte <- especes |> 
        dplyr::filter(taxon == species) |> 
        dplyr::pull(difficulte_id)
      photo_male <- liste_esp |> 
        dplyr::filter(taxon == species) |> 
        dplyr::pull(male)
      photo_femelle <- liste_esp |> 
        dplyr::filter(taxon == species) |> 
        dplyr::pull(femelle)
      cat(
        paste0(
          "\n\n### *", species, "* (", ifelse(is.na(difficulte), "non identifiable à vue", paste0("difficulté ", difficulte)), ")\n\n",
          "<div style='display: flex; justify-content: space-between; gap: 20px;'>",
        ifelse(!is.na(photo_male), paste0("<div><strong>Mâle :</strong><br><a href='javascript:void(0)' onclick=\"openModal('", photo_male, "')\"><img src='", photo_male, "' style='height: 200px; cursor: pointer;'></a></div>"), ''),
        ifelse(!is.na(photo_femelle), paste0("<div><strong>Femelle :</strong><br><a href='javascript:void(0)' onclick=\"openModal('", photo_femelle, "')\"><img src='", photo_femelle, "' style='height: 200px; cursor: pointer;'></a></div>"), ''),
        "</div>\n\n",  # Fin du conteneur flex pour les images
        "<br>![Carte de distribution de *", species, "*](", 
          paste0(
            'https://asfra.fr/Site/User_pages/Atlas/LR_ASFRA_', 
            family, '_', 
            stringr::str_replace(species, pattern = '\\s', replacement = '%20'),
            '_2022-03-10.jpeg'
            ),
            ")\n\n"
          )
      )   

      }
  )
}
%>

<div id="myModal" class="modal">
  <span class="close" onclick="closeModal()">&times;</span>
  <img class="modal-content" id="modalImg">
</div>
